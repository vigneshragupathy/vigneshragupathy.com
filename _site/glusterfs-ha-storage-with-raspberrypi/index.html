<h3 id="overview">Overview</h3>

<p>This post is about how to create a high available redundant storage (Glusterfs replicated volume) from Raspberrypi and a centos server. This is just for fun project, which i am experimenting with my new raspberrypi 2 device. This is not a perfect setup, like i am using a 2 nodes replicated volume without quorom,created brick from ext3 filesystem and on root directory etc.Do not use this setup in production üôÇ</p>

<h3 id="architecture">Architecture</h3>

<p>In this i am using a wifi hotspot router, to act as a DHCP server and connected both the raspberrypi device (server1.vikki.in) using wifi adapter(Edimax 150 Mbps Wireless Nano USB Adaptor) and a laptop running 2 VM‚Äôs ( server2.vikki.in and client.vikki.in)in same wireless network (192.168.1.0)</p>

<p>For details about how to enable wifi interface in raspberrypi please go through the Link</p>

<h3 id="softwares-used">Softwares used</h3>

<p>Ubuntu 14.04<br />
Centos 6.3<br />
Raspbian wheezy<br />
Glusterfs 3.7</p>

<h3 id="hardware-used">Hardware used</h3>

<p>Raspberry PI Model 2 ‚Äì 1GB<br />
Edimax 150 Mbps Wireless Nano USB Adaptor (EW-7811Un)<br />
Cenda T-50 Power Bank 10000 mAh<br />
sandisk ultra 16gb memory card<br />
Wifi router<br />
Laptop</p>

<h3 id="installation">Installation</h3>

<p><strong>Step 1 :</strong></p>

<p>Login to Raspberry pi and run the below command to install glusterfs</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@raspberrypi:~#</span><span class="w"> </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>glusterfs-server</code></pre></figure>

<p><strong>Step 2 :</strong></p>

<p>Login to the centos VM and do the following.</p>

<p>Download the glusterfs version 3.2.7. Since raspbian OS comes wit 3.2.7 , i am downloading the same version to avoid any conflicts.</p>

<p>Note : I tried a combination of version 3.2.7 and the latest version that comes with redhat EPL , but this doesn‚Äôt work out (peer probe connection failed)</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@server2]#</span><span class="w"> </span>wget <span class="nt">-c</span> http://bits.gluster.com/pub/gluster/glusterfs/src/glusterfs-3.2.7.tar.gz</code></pre></figure>

<p>Now download and install all the build dependencies</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@server2]#</span><span class="w"> </span>yum <span class="nb">install </span>flex automake autoconf libtool flex bison openssl-devel libxml2-devel python-devel libaio-devel libibverbs-devel librdmacm-devel readline-devel lvm2-devel glib2-devel userspace-rcu-devel libcmocka-devel libacl-devel</code></pre></figure>

<p>Extract the source file, navigate and do configure</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@server2 glusterfs-3.2.7]#</span><span class="w"> </span>./configureGlusterFS configure summary
<span class="go">===========================
FUSE client : yes
Infiniband verbs : yes
epoll IO multiplex : yes
argp-standalone : no
fusermount : no
readline : yes
georeplication : yes</span></code></pre></figure>

<p>And the finally make and install the gluster</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@server2 glusterfs-3.2.7]#</span><span class="w"> </span>make
<span class="gp">[root@server2 glusterfs-3.2.7]#</span><span class="w"> </span>make <span class="nb">install</span></code></pre></figure>

<h3 id="configuration">Configuration</h3>

<p>Login to raspberrypi and probe the centos server (server2.vikki.in)<br />
server1 :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@raspberrypi:~#</span><span class="w"> </span>gluster peer probe server2.vikki.in
<span class="go">Probe successful</span></code></pre></figure>

<p>Check the peer status<br />
server1 :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@raspberrypi:~#</span><span class="w"> </span>gluster peer status
<span class="go">Number of Peers: 1
Hostname: server2.vikki.in
Uuid: 0531327f-1b4a-4694-b525-58b7277472fd
State: Peer in Cluster (Connected)</span></code></pre></figure>

<p>Similarly login to the centos server and probe the raspberry pi server(server1.vikki.in)<br />
server2 :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@server2 glusterfs]#</span><span class="w"> </span>gluster peer probe server2.vikki.in
<span class="go">Probe successful</span></code></pre></figure>

<p>server2 :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@server2 glusterfs]#</span><span class="w"> </span>gluster peer status
<span class="go">Number of Peers: 1
Hostname: server1.vikki.in
Uuid: 0531327f-1b4a-4694-b525-58b7277472fe
State: Peer in Cluster (Connected)</span></code></pre></figure>

<p>I have a brick /share1 of 1GB size mounted in both raspberrypi and centos server<br />
Now create a replicated volume from any of the server . Here i am creating it from the raspberry pi server(server1.vikki.in)<br />
server1 :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@raspberrypi:/var/log/glusterfs#</span><span class="w"> </span>gluster volume create replicated_volume replica 2 server1.vikki.in:/share1 server2.vikki.in:/share1</code></pre></figure>

<p>Creation of volume replicated_volume has been successful. Please start the volume to access data.<br />
Now start the replicated volume<br />
server1 :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@raspberrypi:/var/log/glusterfs#</span><span class="w"> </span>gluster volume start replicated_volume
<span class="go">Starting volume replicated_volume has been successful</span></code></pre></figure>

<p>Check the replicated volume info</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@server2 glusterfs]#</span><span class="w"> </span>gluster volume info replicated_volumeVolume Name: replicated_volume
<span class="go">Type: Replicate
Status: Started
Number of Bricks: 2
Transport-type: tcp
Bricks:
Brick1: server1.vikki.in:/share1
Brick2: server2.vikki.in:/share1</span></code></pre></figure>

<p>Now the replicated volume is created . Login to the client (client.vikki.in) and mount the glusterfs volume<br />
Client :</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@client ~]#</span><span class="w"> </span>mount.glusterfs server1.vikki.in:/replicated_volume /mnt/gluster/</code></pre></figure>

<p>The replicated volume is successfully mounted in the client</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@client gluster]#</span><span class="w"> </span><span class="nb">df</span> <span class="nt">-h</span>
<span class="go">Filesystem Size Used Avail Use% Mounted on
/dev/sda2 18G 3.5G 14G 21% /
tmpfs 495M 88K 495M 1% /dev/shm
/dev/sda1 291M 33M 244M 12% /boot
server1.vikki.in:/replica_volume
985M 18M 917M 2% /mnt/gluster</span></code></pre></figure>

<h3 id="testing">Testing</h3>

<p>create some files in gluster volume</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@client gluster]#</span><span class="w"> </span><span class="nb">echo</span> ‚Äúwhen both nodes are running‚Äù <span class="o">&gt;</span> file1.txt
<span class="gp">[root@client gluster]#</span><span class="nb">ls</span>
<span class="go">file1.txt</span></code></pre></figure>

<p>Now go to both the server (raspberrypi,centos) and check the individual brick.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@server1 glusterfs]#</span><span class="w"> </span><span class="nb">ls</span> /share1
<span class="go">file1.txt
</span><span class="gp">[root@server2 glusterfs]#</span><span class="w"> </span><span class="nb">ls</span> /share1
<span class="go">file1.txt</span></code></pre></figure>

<p>Now we can see the files are replicated in both the nodes .<br />
Now bring down one of the server and check if the gluster volume is still accessible in client.</p>

<h3 id="my-setup">My setup:</h3>
<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2017/11/pi_extra_small.jpg" class="kg-image" alt="pi_extra_small" /></figure>
<!--kg-card-end: image-->
