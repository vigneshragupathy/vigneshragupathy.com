<p>There are 3 elements involved in RBAC. In this post we are going to see how to provide user level access to resources.</p>

<ul>
  <li>Subjects - Users or Process that wants access to Kubernetes API</li>
  <li>Resources - Kubernetes API objects like pods, deployments etc</li>
  <li>Verbs - Set of operations like get, watch create etc</li>
</ul>

<h3 id="setup"><strong>Setup</strong></h3>

<p>I am using the Virtualbox(running in Ubuntu 18.04 physical machine) for this entire setup . The physical machine is Dell inspiron laptop with 12GB RAM , Intel® Core™ i7-6500U CPU @ 2.50GHz × 4 and 512GB SSD hardisk.</p>

<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2019/11/setup-6.jpg" class="kg-image" /></figure>
<!--kg-card-end: image-->
<h5 id="step-1-create-a-private-key">Step 1: Create a private key</h5>

<p>Create a new directly and navigate to the directory</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span><span class="nb">mkdir </span>ssl
<span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span><span class="nb">cd </span>ssl/</code></pre></figure>

<p>Use openssl command a generate a private key <em>user1.key</em></p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>openssl genrsa <span class="nt">-out</span> user1.key 2048
<span class="go">Generating RSA private key, 2048 bit long modulus
.......................................................+++
.......................................................................................................................................+++
e is 65537 (0x10001)
</span><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">user1.key</span></code></pre></figure>

<h5 id="step-2-generate-a-csr">Step 2: Generate a CSR</h5>

<p>Use the private key generated in the privous step and generate the certificate signing request(csr)</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>openssl req <span class="nt">-new</span> <span class="nt">-key</span> user1.key <span class="nt">-out</span> user1.csr <span class="nt">-subj</span> <span class="s2">"/CN=user1/O=vikki.in"</span>
<span class="go">
</span><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">user1.csr user1.key</span></code></pre></figure>

<h5 id="step-3-sign-the-csr-and-generate-certificate">Step 3: Sign the CSR and generate certificate</h5>

<p>The kubernetes cluster have the CA(certificate authority) key and certificate available under /etc/kubernetes/pki location</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span><span class="nb">ls</span> /etc/kubernetes/pki/ca.
<span class="go">ca.crt ca.key  </span></code></pre></figure>

<p>Use the CA certificate and key to sign the CSR</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span><span class="nb">sudo </span>openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> user1.csr <span class="nt">-CA</span> /etc/kubernetes/pki/ca.crt <span class="nt">-CAkey</span> /etc/kubernetes/pki/ca.key <span class="nt">-CAcreateserial</span> <span class="nt">-out</span> user1.crt <span class="nt">-days</span> 365
<span class="go">[sudo] password for vikki: 
Signature ok
subject=/CN=user1/O=vikki.in
Getting CA Private Key

</span><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">user1.crt user1.csr user1.key</span></code></pre></figure>

<blockquote>
  <p>Now we have the private key <em>user1.key</em> and signed certificate <em>user1.crt</em></p>
</blockquote>

<h5 id="step-4-set-credential-for-the-user">Step 4: Set credential for the user</h5>

<p>Now set credential for the user <em>user1</em> with the private key and the signed certificate.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl config set-credentials user1 <span class="nt">--client-certificate</span><span class="o">=</span>user1.crt <span class="nt">--client-key</span><span class="o">=</span>user1.key 
<span class="go">User "user1" set.</span></code></pre></figure>

<h5 id="step-5-set-context-for-the-user">Step 5: Set context for the user</h5>

<p>Now set the new context with the username , cluster etc.</p>

<p>We can also map the context to specific namespace using the –namespacec option. By default it will take the default namespace</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl config set-context user1-context <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="nt">--user</span><span class="o">=</span>user1
<span class="go">Context "user1-context" created.

</span><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl config get-contexts 
<span class="go">CURRENT NAME CLUSTER AUTHINFO NAMESPACE
* kubernetes-admin@kubernetes kubernetes kubernetes-admin   
            user1-context kubernetes user1              </span></code></pre></figure>

<blockquote>
  <p>Now we can see there are 2 context created.</p>
</blockquote>

<h5 id="step-6-create-a-role">Step 6: Create a role</h5>

<p>Create a role and map the resources and verb required.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl create role myrole <span class="nt">--verb</span><span class="o">=</span>get,create,list <span class="nt">--resource</span><span class="o">=</span>pods
<span class="go">role.rbac.authorization.k8s.io/myrole created</span></code></pre></figure>

<h5 id="step-7-create-a-rolebinding">Step 7: Create a rolebinding</h5>

<p>Create a rolebinding and map the role and user.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl create rolebinding myrolebinding <span class="nt">--role</span><span class="o">=</span>myrole <span class="nt">--user</span><span class="o">=</span>user1 
<span class="go">rolebinding.rbac.authorization.k8s.io/myrolebinding created</span></code></pre></figure>

<h5 id="step-8-verify-role-and-rolebinding">Step 8: Verify role and rolebinding</h5>

<p>List the role and rolebinding and verify both are created.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl get role
<span class="go">NAME AGE
myrole 58s
</span><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl get rolebindings.rbac.authorization.k8s.io 
<span class="go">NAME AGE
myrolebinding 8s</span></code></pre></figure>

<h5 id="step-9-change-the-context-and-verify-role-based-access">Step 9: Change the context and verify role based access</h5>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl config get-contexts 
<span class="go">CURRENT NAME CLUSTER AUTHINFO NAMESPACE
* kubernetes-admin@kubernetes kubernetes kubernetes-admin   
            user1-context kubernetes user1     </span></code></pre></figure>

<p>Switch to newly created contesxt <em>user1-context</em></p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl config use-context user1-context 
<span class="go">Switched to context "user1-context".

</span><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl config get-contexts 
<span class="go">CURRENT NAME CLUSTER AUTHINFO NAMESPACE
            kubernetes-admin@kubernetes kubernetes kubernetes-admin   
* user1-context kubernetes user1           </span></code></pre></figure>

<blockquote>
  <p>Now we can see the current context is switched to <em>user1-context.</em></p>
</blockquote>

<p>Try to create a deployement</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl run nginx-deployment <span class="nt">--image</span><span class="o">=</span>nginx
<span class="go">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.
Error from server (Forbidden): deployments.apps is forbidden: User "user1" cannot create resource "deployments" in API group "apps" in the namespace "default"</span></code></pre></figure>

<blockquote>
  <p>The deployment creation is failed because the new context has resource mapped only for pod.</p>
</blockquote>

<p>Now lets create a pod and verify the status</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>vim pod.yaml</code></pre></figure>
<!--kg-card-begin: html-->
<script src="https://gist.github.com/vigneshragupathy/aa1503f5161a453f120ab6b121f6325a.js"></script>
<!--kg-card-end: html-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pod.yaml 
<span class="go">pod/myapp-pod created</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~/ssl$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
httpd-7765f5994-vc2j5 1/1 Running 1 2d
myapp-pod 0/1 ContainerCreating 0 5s
nginx-7bffc778db-p4ff5 1/1 Running 1 2d</span></code></pre></figure>

<blockquote>
  <p>We can see now the pod created successfully and running in the new context.</p>
</blockquote>

<p>We can also test the permission of user using the below command</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl auth can-i create deployments <span class="nt">--as</span> user1
<span class="go">no

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl auth can-i create pods <span class="nt">--as</span> user1
<span class="go">yes</span></code></pre></figure>
