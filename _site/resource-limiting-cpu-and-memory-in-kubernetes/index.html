<p>In my previous post, we seen how to <a href="/kubernetes-on-ubuntu-18-04-with-dashbaoard">configure kubernetes cluster</a> ,<a href="/kubernetes-growing-the-cluster-with-centos-7-node/">how to deploy pods and grow the cluster</a>. Now in this post i am going to show how to resource limiting cpu and memory in a kubernetes deployment. We can also limit resource at namespace level, which will be covered in the later post.</p>

<p>I am going to use a special image <a href="https://hub.docker.com/r/vish/stress/">vish/stress</a>. This image has options for allocating cpu and memory, which can be parsed using an argument for doing the stress test.</p>

<p>My configuration for Master and Worker node is 4GB memory with 2 CPU cores each running in Virtualbox.</p>

<p>First download the vish/stress image and create the deployment. The image vish/stress provides option for creating stress in cpu and memory</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl run stress-test <span class="nt">--image</span><span class="o">=</span>vish/stress
<span class="go">deployment.apps "stress-test" created</span></code></pre></figure>

<p>Wait till the pods status changes to running.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
nginx-768979984b-mmgbj 1/1 Running 6 65d
stress-test-7795ffcbb-r9mft 0/1 ContainerCreating 0 6s
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
nginx-768979984b-mmgbj 1/1 Running 6 65d
stress-test-7795ffcbb-r9mft 1/1 Running 0 32s</span></code></pre></figure>

<p>Now verify the logs from respective container image. In my case the container name for pod stress-test-7795ffcbb-r9mft is e8e43da13b23.<br />
You can also use <code class="language-plaintext highlighter-rouge">"kubernetes logs stress-test-7795ffcbb-r9mft"</code>(but its not working in my server)</p>

<p>It shows allocating 0 memory. By default the stress image will not allocation any memory/cpu.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>docker logs e8e43da13b23
<span class="go">I0819 13:01:00.200714 1 main.go:26] Allocating "0" memory, in "4Ki" chunks, with a 1ms sleep between allocations
I0819 13:01:00.200804 1 main.go:29] Allocated "0" memory</span></code></pre></figure>

<h3 id="limiting-memory-and-cpu-for-the-pod">Limiting Memory and CPU for the pod</h3>

<p>We are going to allocate more memory for this deployment and also going to set resource limit for CPU and Memory. Finally will monitor the deployment behaviour.</p>

<p>Export the yaml for the current deployment “stress-test” and add the resource limit option and Memory/CPU allocation option.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get deployment stress-test <span class="nt">-o</span> yaml <span class="o">&gt;</span> stress.test.yaml
<span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>vim stress.test.yaml</code></pre></figure>

<p>Now in the above example i restricted cpu to 1 cores and memory to 4GB using limits options. Also i added the argument to allocate 2 cores and memory of 5050MB(~5GB).</p>

<p>The requests and limits option is analogous to the soft and hard limit in Linux.</p>

<p>My total memory available in the worker node is only 4 GB,I am over allocating memory just to check the behaviour. In real case you will be limiting the resources lesser than the available Memory/CPU, otherwise it makes no sense.</p>

<p>Now apply the new yaml to the deployment and wait for the pods to go running status.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl replace <span class="nt">-f</span> stress.test.yaml 
<span class="go">deployment.extensions "stress-test" replaced
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
nginx-768979984b-mmgbj 1/1 Running 6 65d
stress-test-7795ffcbb-r9mft 0/1 ContainerCreating 0 8s
stress-test-78944d5478-wmmtc 0/1 Terminating 0 20m
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
nginx-768979984b-mmgbj 1/1 Running 6 65d
stress-test-7795ffcbb-r9mft 1/1 Running 0 32s
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<p>Check the logs in the container. Its trying to allocate 5050MB memory and 2 CPU.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>docker logs a9ebee58d3ca
<span class="go">I0819 13:36:36.618405 1 main.go:26] Allocating "5050Mi" memory, in "100Mi" chunks, with a 1s sleep between allocations
I0819 13:36:36.618655 1 main.go:39] Spawning a thread to consume CPU
I0819 13:36:36.618674 1 main.go:39] Spawning a thread to consume CPU</span></code></pre></figure>

<p>Open a new terminal and monitor the Memory usage.</p>

<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2018/08/Screenshot-from-2018-08-19-19-12-37.png" class="kg-image" alt="Screenshot-from-2018-08-19-19-12-37" /></figure>
<!--kg-card-end: image-->

<p>The memory will slowly raises to full usage and finally drops .After some attempts the pod will go “Crashloopbackoff” status.</p>

<h4 id="memory-value-plotted-in-graph">Memory value plotted in graph</h4>
<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2018/08/Screenshot-from-2018-08-19-20-40-03.png" class="kg-image" alt="Screenshot-from-2018-08-19-20-40-03" /></figure>
<!--kg-card-end: image-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
nginx-768979984b-mmgbj 1/1 Running 6 65d
stress-test-57bb689598-8h4zm 0/1 CrashLoopBackOff 3 4m
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<p>To verify the reason for container termination, we can run the describe pod. In our case it clearly say OOMKilled and was  26 times restarted.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl describe pod stress-test-dbbcf4fd7-pqh99 |grep <span class="nt">-A</span> 5 State
<span class="go">    State: Waiting
        Reason: CrashLoopBackOff
    Last State: Terminated
        Reason: OOMKilled
        Exit Code: 137
        Started: Sun, 19 Aug 2018 21:23:01 +0530
        Finished: Sun, 19 Aug 2018 21:23:24 +0530
    Ready: False
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl describe pod stress-test-dbbcf4fd7-pqh99 |grep <span class="nt">-i</span> restart
<span class="go">    Restart Count: 26
    Warning BackOff 2m (x480 over 2h) kubelet, drona-child-3 Back-off restarting failed container
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>
