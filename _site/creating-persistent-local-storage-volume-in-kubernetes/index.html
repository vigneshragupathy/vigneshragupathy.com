<p>PersistentVolume and PersistentVolumeClaim in kubernetes provides a way to allocate storage for the pods. Kubernetes PV supports different types of storage. Now here in the below post we are going to use storage-class <strong>local-storage</strong> and watch the behaviour for different reclaimpolicy.</p>

<h3 id="setup"><strong>Setup</strong></h3>

<p>I am using the Virtualbox(running in Ubuntu 18.04 physical machine) for this entire setup . The physical machine is Dell inspiron laptop with 12GB RAM , Intel® Core™ i7-6500U CPU @ 2.50GHz × 4 and 512GB SSD hardisk.</p>

<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2019/11/Screenshot-from-2019-11-23-11-56-54-2.png" class="kg-image" /></figure>
<!--kg-card-end: image-->
<h5 id="step-1-create-a-directory-in-one-for-the-node-and-add-a-file">Step 1: Create a directory in one for the node and add a file</h5>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kubernetes2:~#</span><span class="w"> </span><span class="nb">mkdir</span> /pvdir
<span class="gp">root@kubernetes2:~#</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"Hello world!"</span> <span class="o">&gt;</span> /pvdir/index.html 
<span class="gp">root@kubernetes2:~#</span><span class="w"> </span><span class="nb">cat</span> /pvdir/index.html 
<span class="go">Hello world!</span></code></pre></figure>

<h5 id="step-2-get-the-label-of-the-node">Step 2: Get the label of the node</h5>

<p>We need to get the label of the node where the directory is created.This we need to configure  in the nodeAffinity specs in order to properly stick the pod to respective node where the local volume is present.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get nodes <span class="nt">--show-labels</span>
<span class="go">NAME STATUS ROLES AGE VERSION LABELS
kubernetes1 Ready master 19d v1.16.2 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=kubernetes1,kubernetes.io/os=linux,node-role.kubernetes.io/master=
</span><span class="gp">kubernetes2 Ready &lt;none&gt;</span><span class="w"> </span>19d v1.16.2 beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>kubernetes2,kubernetes.io/os<span class="o">=</span>linux</code></pre></figure>

<h5 id="step-3-create-a-persistent-volumepv">Step 3: Create a persistent volume(PV)</h5>

<p>Create a PV and map the local storage director and configure the label in the node selector</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>vim pv.yaml</code></pre></figure>
<!--kg-card-begin: html-->
<script src="https://gist.github.com/vigneshragupathy/b0fdde697229f150740a079b77458d64.js"></script>
<!--kg-card-end: html-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pv.yaml 
<span class="go">persistentvolume/vikki-pv-volume created</span></code></pre></figure>

<h5 id="step-4-verify-the-pv-status">Step 4: Verify the PV status</h5>

<p>Verify the PV status. It is currently configured with access type <strong>RWO</strong> and reclaim policy as <strong>Delete</strong></p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pv
<span class="go">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
vikki-pv-volume 1Gi RWO Delete Available local-storage 14s</span></code></pre></figure>

<h5 id="step-5-create-a-persistent-volume-claimpvc">Step 5: Create a persistent volume claim(PVC)</h5>

<p>Create a PVC and map the above created PV</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>vim pv_claim.yaml</code></pre></figure>
<!--kg-card-begin: html-->
<script src="https://gist.github.com/vigneshragupathy/5f9f6acb132e499ccb80523b170dc815.js"></script>
<!--kg-card-end: html-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pv_claim.yaml 
<span class="go">persistentvolumeclaim/vikki-pv-volume-claim created</span></code></pre></figure>

<h5 id="step-6-verify-the-pvc-status">Step 6: Verify the PVC status</h5>

<p>Verify the PVC and PV status. Now we can see the status changes from <em>Available</em> to <em>Bound.</em></p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pvc
<span class="go">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
vikki-pv-volume-claim Bound vikki-pv-volume 1Gi RWO local-storage 8s
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pv
<span class="go">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
vikki-pv-volume 1Gi RWO Delete Bound default/vikki-pv-volume-claim local-storage 3m59s</span></code></pre></figure>

<h5 id="step-7-create-a-pod-and-map-the-pvc">Step 7: Create a pod and map the PVC</h5>

<p>Create a pod and map the volumes as below</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl run <span class="nt">--image</span><span class="o">=</span>nginx nginx-pod <span class="nt">--generator</span><span class="o">=</span>run-pod/v1 <span class="nt">--dry-run</span> <span class="nt">-o</span> yaml <span class="o">&gt;</span> pod.yaml</code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>vim pod.yaml</code></pre></figure>
<!--kg-card-begin: html-->
<script src="https://gist.github.com/vigneshragupathy/76f42e185c516284f0babbdc3b67cd1a.js"></script>
<!--kg-card-end: html-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pod.yaml 
<span class="go">pod/nginx-pod created</span></code></pre></figure>

<h5 id="step-8-verify-the-pod-status-and-volume-inside">Step 8: Verify the pod status and volume inside</h5>

<p>Verify the status of the new pod and check the volume is mounted inside the container</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
fluentd-elasticsearch-bwhfx 0/1 ImagePullBackOff 0 4h3m
fluentd-elasticsearch-pvlpv 0/1 ImagePullBackOff 0 4h3m
nginx-85ff79dd56-zqllr 1/1 Running 1 5h51m
nginx-pod 1/1 Running 0 10s</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker ps <span class="nt">-a</span> |grep nginx-pod
<span class="go">e142048a048f nginx "nginx -g 'daemon of…" 20 seconds ago Up 20 seconds k8s_nginx-pod_nginx-pod_default_b6b900bb-b214-4b96-bc90-18b2358ee225_0
df59f401a38a k8s.gcr.io/pause:3.1 "/pause" 26 seconds ago Up 25 seconds k8s_POD_nginx-pod_default_b6b900bb-b214-4b96-bc90-18b2358ee225_0</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-it</span> k8s_nginx-pod_nginx-pod_default_b6b900bb-b214-4b96-bc90-18b2358ee225_0 <span class="nb">cat</span> /usr/share/nginx/html/index.html
<span class="go">Hello world!</span></code></pre></figure>

<blockquote>
  <p>Now we can see the directory from the PV is mounted in the pod and the files created are present</p>
</blockquote>

<h2 id="verify-reclaim-policybelow-steps-are-optional">Verify reclaim policy(Below steps are Optional)</h2>

<h5 id="step-9-delete-pvc-and-verify-pv">Step 9: Delete PVC and verify PV</h5>

<p>Now delete the pod and PVC and verify the status of PV</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pod nginx-pod
<span class="go">pod "nginx-pod" deleted</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pvc vikki-pv-volume-claim 
<span class="go">persistentvolumeclaim "vikki-pv-volume-claim" deleted</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pv
<span class="go">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
vikki-pv-volume 1Gi RWO Delete Failed default/vikki-pv-volume-claim local-storage 5m30s</span></code></pre></figure>

<blockquote>
  <p>We can see the staus of PV is automaticall changed to <strong>Failed.</strong> This is due the the reclaim policy <strong>Delete</strong></p>
</blockquote>

<h5 id="step-10-optional--try-recreate-pvc">Step 10: (Optional ) Try recreate PVC</h5>

<p>We can optionally try recreating the PVC volume and verify the status</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pv_claim.yaml 
<span class="go">persistentvolumeclaim/vikki-pv-volume-claim created</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pv
<span class="go">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
vikki-pv-volume 1Gi RWO Delete Failed default/vikki-pv-volume-claim local-storage 5m57s
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pvc
<span class="go">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
vikki-pv-volume-claim Pending local-storage 2m10s</span></code></pre></figure>

<blockquote>
  <p>We can see the status of PV is still <strong>Failed</strong> and the PVC always in <strong>Pending</strong> and never creates</p>
</blockquote>

<h5 id="step-11-delete-and-create-pv-with-reclaim-policy-as-retain">Step 11: Delete and create PV with reclaim policy as retain</h5>

<p>Now lets clean up all PV and PVC and recreate PV with reclaim policy set as “Retain”</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pvc vikki-pv-volume-claim 
<span class="go">persistentvolumeclaim "vikki-pv-volume-claim" deleted

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pv vikki-pv-volume 
<span class="go">persistentvolume "vikki-pv-volume" deleted</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>vim pv.yaml
<span class="go">persistentVolumeReclaimPolicy: Retain</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pv.yaml 
<span class="go">persistentvolume/vikki-pv-volume created
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> pv_claim.yaml 
<span class="go">persistentvolumeclaim/vikki-pv-volume-claim created</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pvc,pv
<span class="go">NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE
persistentvolumeclaim/vikki-pv-volume-claim Bound vikki-pv-volume 1Gi RWO local-storage 99s

NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
persistentvolume/vikki-pv-volume 1Gi RWO Retain Bound default/vikki-pv-volume-claim local-storage 118s</span></code></pre></figure>

<h5 id="step-12-delete-the-pvc-and-verify-the-status-of-pv">Step 12: Delete the PVC and verify the status of PV</h5>

<p>Now lets delete the PVC and verify the status of the PV</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pvc vikki-pv-volume-claim 
<span class="go">persistentvolumeclaim "vikki-pv-volume-claim" deleted</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pv
<span class="go">NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE
vikki-pv-volume 1Gi RWO Retain Released default/vikki-pv-volume-claim local-storage 2m11s</span></code></pre></figure>

<blockquote>
  <p>Now we can see the status of PV changes to “Released” instead of “Failed” due to the reclaim policy “Retain”</p>
</blockquote>

