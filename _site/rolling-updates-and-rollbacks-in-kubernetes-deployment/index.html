<p>Kubernetes provides rollout options to do  update on deployment and easily fallback to any revision. We are going to see how to update the deployment to a newer version of container image and rollback to previous version without affecting the services</p>

<h3 id="setup"><strong>Setup</strong></h3>

<p>I am using the Virtualbox(running in Ubuntu 18.04 physical machine) for this entire setup . The physical machine is Dell inspiron laptop with 12GB RAM , Intel® Core™ i7-6500U CPU @ 2.50GHz × 4 and 512GB SSD hardisk.</p>

<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2019/11/Screenshot-from-2019-11-23-11-56-54.png" class="kg-image" /></figure>
<!--kg-card-end: image-->
<h3 id="step-1-create-a-deployment">Step 1: Create a deployment</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx
<span class="go">deployment.apps/nginx created

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get deployments <span class="nt">-o</span> wide
<span class="go">NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR
nginx 1/1 1 1 25s nginx nginx app=nginx</span></code></pre></figure>

<h3 id="step-2-export-the-deployment-to-yaml-file-and-add-the-port-optionfor-nginx-image-the-port-is-80">Step 2: Export the deployment to yaml file and add the port option(for nginx image the port is 80)</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get deployments <span class="nt">-o</span> yaml <span class="o">&gt;</span> nginx.yaml
<span class="go">
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>vim nginx.yaml
<span class="go">ports:
        - containerPort: 80
            protocol: TCP</span></code></pre></figure>

<h3 id="step-3-apply-the-changes-to-the-deployment">Step 3: Apply the changes to the deployment</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> nginx.yaml
<span class="go">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl applydeployment.apps/nginx configured</span></code></pre></figure>

<h3 id="step-4-expose-the-deployment-as-clusterip">Step 4: Expose the deployment as ClusterIP</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl expose deployment nginx <span class="nt">--type</span><span class="o">=</span>ClusterIP
<span class="go">service/nginx exposed

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get service nginx
<span class="go">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE
nginx ClusterIP 10.102.68.171 80/TCP 8s</span></code></pre></figure>

<h3 id="step-5-verify-the-service-by-accessing-nginx-deployment-using-the-clusterip">Step 5: Verify the service by accessing nginx deployment using the ClusterIP</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>curl 10.102.68.171
<span class="go">Welcome to nginx!
If you see this page, the nginx web server is successfully installed and working. Further configuration is required.
For online documentation and support please refer to nginx.org.Commercial support is available at nginx.com.
Thank you for using nginx.</span></code></pre></figure>

<h3 id="step-6-verify-the-current-version-of-nginx">Step 6: Verify the current version of Nginx</h3>

<p>Go to the kubernetes node kubernetes2 and verify the nginx version</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-it</span> k8s_nginx_nginx-85ff79dd56-mch7j_default_4608325f-2432-4ff3-86ab-e1f2b01dd8f2_0 nginx <span class="nt">-v</span>
<span class="go">nginx version: nginx/1.17.6</span></code></pre></figure>

<blockquote>
  <p>Now we have made 2 changes to the nginx deployment</p>
</blockquote>

<ul>
  <li>Orignal Nginx deployment</li>
  <li>Nginx deployment with container port set as 80</li>
</ul>

<h3 id="step-7-set-nginx-with-a-different-image-version">Step 7: set Nginx with a different image version</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl <span class="nb">set </span>image deployment nginx <span class="nv">nginx</span><span class="o">=</span>nginx:1.9.1
<span class="go">deployment.apps/nginx image updated</span></code></pre></figure>

<p>Verify the nginx version in node kubernetes2</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker ps <span class="nt">-a</span> |grep nginx
<span class="go">e547e6fc1ad1 nginx "nginx -g 'daemon of…" 37 seconds ago Up 36 seconds k8s_nginx_nginx-69fbc8b64f-2k6wm_default_4695011d-de3b-497d-81b3-2f5de48c3e92_0
1142c1ff00ee k8s.gcr.io/pause:3.1 "/pause" 41 seconds ago Up 40 seconds k8s_POD_nginx-69fbc8b64f-2k6wm_default_4695011d-de3b-497d-81b3-2f5de48c3e92_0
</span><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-it</span> k8s_nginx_nginx-69fbc8b64f-2k6wm_default_4695011d-de3b-497d-81b3-2f5de48c3e92_0 nginx <span class="nt">-v</span>
<span class="go">nginx version: nginx/1.9.1</span></code></pre></figure>

<p>Now the nginix version is changed from <strong>1.17.6</strong> to <strong>1.9.1</strong></p>

<h3 id="step-8-verify-the-service-by-accessing-nginx-deployment-using-the-clusterip">Step 8: Verify the service by accessing nginx deployment using the ClusterIP</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>curl 10.102.68.171
<span class="go">Welcome to nginx!
If you see this page, the nginx web server is successfully installed and working. Further configuration is required.
For online documentation and support please refer to nginx.org.Commercial support is available at nginx.com.
Thank you for using nginx.</span></code></pre></figure>

<h3 id="step-9-verify-the-rollout-history">Step 9: Verify the rollout history</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl rollout <span class="nb">history </span>deployment nginx 
<span class="go">deployment.apps/nginx
REVISION CHANGE-CAUSE
1         
2         
3</span></code></pre></figure>

<blockquote>
  <p>Now we have made 3 changes to the nginx deployment</p>
</blockquote>

<h3 id="step-10-now-rollback-to-older-revision-and-verify-the-nginx-version-changes">Step 10: Now rollback to older revision and verify the nginx version changes</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl rollout undo deployment nginx <span class="nt">--to-revision</span><span class="o">=</span>2
<span class="go">deployment.apps/nginx rolled back
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl rollout status deployment nginx
<span class="go">deployment "nginx" successfully rolled out</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker ps <span class="nt">-a</span> |grep nginx
<span class="go">5825d85fca05 nginx "nginx -g 'daemon of…" 11 seconds ago Up 11 seconds k8s_nginx_nginx-85ff79dd56-6vjx6_default_3ae5f3ba-af97-4320-9684-46c2ad8f69d6_0
8467c77a5e10 k8s.gcr.io/pause:3.1 "/pause" 17 seconds ago Up 16 seconds k8s_POD_nginx-85ff79dd56-6vjx6_default_3ae5f3ba-af97-4320-9684-46c2ad8f69d6_0
1142c1ff00ee k8s.gcr.io/pause:3.1 "/pause" 3 minutes ago Exited (0) 9 seconds ago k8s_POD_nginx-69fbc8b64f-2k6wm_default_4695011d-de3b-497d-81b3-2f5de48c3e92_0

</span><span class="gp">root@kubernetes2:~#</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-it</span> k8s_nginx_nginx-85ff79dd56-6vjx6_default_3ae5f3ba-af97-4320-9684-46c2ad8f69d6_0 nginx <span class="nt">-v</span>
<span class="go">nginx version: nginx/1.17.6</span></code></pre></figure>

<p>Now the nginix version is changed from   <strong>1.9.1</strong> to <strong>1.17.6</strong></p>

<h3 id="step-11-verify-the-service-by-accessing-nginx-deployment-using-the-clusterip">Step 11: Verify the service by accessing nginx deployment using the ClusterIP</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>curl 10.102.68.171
<span class="go">Welcome to nginx!
If you see this page, the nginx web server is successfully installed and working. Further configuration is required.
For online documentation and support please refer to nginx.org.Commercial support is available at nginx.com.
Thank you for using nginx.</span></code></pre></figure>

<blockquote>
  <p>We successfully done the rollout in nginx deployment</p>
</blockquote>

