<p>Daemonset ensures that all the nodes run a copy of a pod. It can be used for running storage/monitoring daemons like glusterd,Prometheus etc. Now in this post we are going to see how to create a daemonset and do an image update. We are also going to perform different update strategy and watch the behaviour of damonset updates.</p>

<h3 id="setup"><strong>Setup</strong></h3>

<p>I am using the Virtualbox(running in Ubuntu 18.04 physical machine) for this entire setup . The physical machine is Dell inspiron laptop with 12GB RAM , Intel® Core™ i7-6500U CPU @ 2.50GHz × 4 and 512GB SSD hardisk.</p>

<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2019/11/Screenshot-from-2019-11-23-11-56-54-1.png" class="kg-image" /></figure>
<!--kg-card-end: image-->
<h3 id="step-1-create-a-daemon-set">Step 1: Create a daemon set</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl create <span class="nt">-f</span> ds.yaml 
<span class="go">daemonset.apps/fluentd-elasticsearch created</span></code></pre></figure>
<!--kg-card-begin: html-->
<script src="https://gist.github.com/vigneshragupathy/467337d30e6018fae4d33af6d762f36d.js"></script>
<!--kg-card-end: html-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get ds
<span class="go">NAME DESIRED CURRENT READY UP-TO-DATE AVAILABLE NODE SELECTOR AGE
</span><span class="gp">fluentd-elasticsearch 2 2 2 2 2 &lt;none&gt;</span><span class="w"> </span>5s</code></pre></figure>

<h3 id="step-2-verify-the-image-version-and-updatestrategy-of-the-daemonset">Step 2: Verify the image version and updateStrategy of the daemonset</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe ds fluentd-elasticsearch |grep Image
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get ds fluentd-elasticsearch <span class="nt">-o</span> yaml |grep <span class="nt">-A</span> 3 <span class="nt">-i</span> updateStrategy
<span class="go">    updateStrategy:
    rollingUpdate:
        maxUnavailable: 1
    type: RollingUpdate

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pod fluentd-elasticsearch-
<span class="go">fluentd-elasticsearch-7ds49 fluentd-elasticsearch-qh8n8  
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe pod fluentd-elasticsearch-7ds49 |grep Image:
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2
    </span></code></pre></figure>

<blockquote>
  <p>The daemonset has a image version of “ <strong>2.5.2”</strong> and updateStrategy “ <strong>RollingUpdate</strong>”</p>
</blockquote>

<h3 id="step-3-update-the-daemon-set-container-image-to-a-different-version-say-252">Step 3: Update the daemon set container image to a different version say “2.5.2”</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl <span class="nb">set </span>image ds fluentd-elasticsearch fluentd-elasticsearch<span class="o">=</span>quay.io/fluentd_elasticsearch/fluentd:v2.5.1
<span class="go">daemonset.apps/fluentd-elasticsearch image updated</span></code></pre></figure>

<h3 id="step-4--verify-the-image-version-is-updated-in-daemonset-level-also-in-pod-level">step 4 : Verify the image version is updated in daemonset level also in pod level</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe ds fluentd-elasticsearch |grep Image
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.1

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe pod fluentd-elasticsearch-
<span class="go">fluentd-elasticsearch-qh8n8 fluentd-elasticsearch-x2f57  
</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe pod fluentd-elasticsearch-qh8n8 |grep Image:
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.1</span></code></pre></figure>

<blockquote>
  <p>Now we can see , as soon as the daemonset image is updated , the pod image also gets updated. This is because of the updateStrategy set as <strong>RollingUpdate</strong></p>
</blockquote>

<h3 id="step-5-now-lets-change-the-updatestrategy-to-ondelete-and-watch-the-behaviour">Step 5: Now lets change the updateStrategy to OnDelete and watch the behaviour</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get ds fluentd-elasticsearch <span class="nt">-o</span> yaml <span class="o">&gt;</span> ds_new.yaml 
<span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>vim ds_new.yaml 
<span class="go">    
    
    </span></code></pre></figure>
<!--kg-card-begin: html-->
<script src="https://gist.github.com/vigneshragupathy/573453ca14d2e79e02f3cfe6c7a3ef20.js"></script>
<!--kg-card-end: html-->
<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> ds_new.yaml 
<span class="go">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
daemonset.apps/fluentd-elasticsearch configured</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe ds fluentd-elasticsearch |grep Image
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.1

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get ds fluentd-elasticsearch <span class="nt">-o</span> yaml |grep <span class="nt">-A</span> 3 <span class="nt">-i</span> updateStrategy
<span class="go">--
    updateStrategy:
    rollingUpdate:
        maxUnavailable: 1
    type: OnDelete

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe pod fluentd-elasticsearch-qh8n8 |grep Image:
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2
    </span></code></pre></figure>

<blockquote>
  <p>The udpate strategy is changed to <strong>OnDelete</strong> and the version in <strong>2.5.2</strong></p>
</blockquote>

<h3 id="step-6-lets-change-the-image-to-different-version">Step 6: Lets change the image to different version</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl <span class="nb">set </span>image ds fluentd-elasticsearch fluentd-elasticsearch<span class="o">=</span>quay.io/fluentd_elasticsearch/fluentd:v2.5.0
<span class="go">daemonset.apps/fluentd-elasticsearch image updated</span></code></pre></figure>

<h3 id="step-7-verify-the-image-version-in-daemonset-and-pod">Step 7: Verify the image version in daemonset and pod</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe ds fluentd-elasticsearch |grep Image
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.0

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe pod fluentd-elasticsearch-qh8n8 |grep Image:
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></code></pre></figure>

<blockquote>
  <p>Now we can see the image version on Daemonset is updated , but the pod is still running in the older version</p>
</blockquote>

<h3 id="step-8-lets-delete-the-pod-and-wait-for-the-new-pods-to-be-created-and-verify-the-image-version-in-new-pod">Step 8: Lets delete the pod and wait for the new pods to be created and verify the image version in new pod</h3>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pod fluentd-elasticsearch-
<span class="go">fluentd-elasticsearch-qh8n8 fluentd-elasticsearch-x2f57  

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl delete pod fluentd-elasticsearch-qh8n8 fluentd-elasticsearch-x2f57
<span class="go">pod "fluentd-elasticsearch-qh8n8" deleted
pod "fluentd-elasticsearch-x2f57" deleted</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pod fluentd-elasticsearch-
<span class="go">fluentd-elasticsearch-89g44 fluentd-elasticsearch-mf5f9  

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl get pod fluentd-elasticsearch-
<span class="go">fluentd-elasticsearch-89g44 fluentd-elasticsearch-mf5f9  

</span><span class="gp">vikki@kubernetes1:~$</span><span class="w"> </span>kubectl describe pod fluentd-elasticsearch-89g44 |grep Image:
<span class="go">    Image: quay.io/fluentd_elasticsearch/fluentd:v2.5.0</span></code></pre></figure>

<blockquote>
  <p>Now we can see the version is automatically updated on the new pod only after delete.</p>
</blockquote>

