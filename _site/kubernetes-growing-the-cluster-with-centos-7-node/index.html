<p>In my <a href="/kubernetes-on-ubuntu-18-04-with-dashbaoard/#kubernetes-token-generation">previous post</a> we seen how to install and configure kubernetes master node and dashboard on Ubuntu 18.04. Now this post is about growing the Kubernetes master by joining more nodes. For this setup i am going to use a Centos 7 VM running in virtualbox.</p>

<!--kg-card-begin: image-->
<figure class="kg-card kg-image-card"><img src="/content/images/2018/06/vikki_centos7_vbox.jpg" class="kg-image" alt="vikki_centos7_vbox" /></figure>
<!--kg-card-end: image-->
<h3 id="installation">Installation</h3>

<p>Fist update the centos with all latest packages</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>yum update <span class="nt">-y</span></code></pre></figure>

<p>Install docker and enable in startup</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>yum <span class="nb">install </span>docker
<span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>systemctl <span class="nb">enable </span>docker <span class="o">&amp;&amp;</span> systemctl start docker
<span class="go">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span></code></pre></figure>

<p>Now add the kubernetes repository to yum configuration</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/yum.repos.d/kubernetes.repo
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">[kubernetes]
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">name=Kubernetes
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">enabled=1
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">gpgcheck=1
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">repo_gpgcheck=1
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span><span class="gp">&gt;</span><span class="w"> </span><span class="sh">EOF</span></code></pre></figure>

<p>Disable selinux. For permanant disable edit the file “/etc/sysconfig/selinux”  otherwise the kube-flannel-xxx will goes to crashloop in next reboot.<br />
After that install kubernetes packages and enable in startup.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>setenforce 0
<span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm 
<span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>systemctl <span class="nb">enable </span>kubelet <span class="o">&amp;&amp;</span> systemctl start kubelet
<span class="go">Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /etc/systemd/system/kubelet.service.
</span><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span></code></pre></figure>

<p>Add the host entry for name resolution</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span><span class="nb">cat</span> /etc/hosts
<span class="go">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
::1 localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.0.5 drona-child-1
192.168.0.4 drona-child-3
</span><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span></code></pre></figure>

<p>Disable swap</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>swapoff <span class="nt">-a</span></code></pre></figure>

<p>Till this step everything is same as we did in kubernetes master, except the difference of centos 7 operation system.</p>

<h3 id="adding-nodes-to-the-cluster">Adding nodes to the cluster</h3>

<p>Now join the node to the kubernetes master using the join command. We already seen in the <a href="/kubernetes-on-ubuntu-18-04-with-dashbaoard/#kubernetes-token-generation">previous post</a> how to get the token and hash in case you didn’t note it during master installation.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>kubeadm <span class="nb">join </span>192.168.1.5:6443 <span class="nt">--token</span> o9an7t.o4bs1up74xjwnol3 <span class="nt">--discovery-token-ca-cert-hash</span> sha256:548c922cf4f845f3dc6d7da407516652879c8a5085c87e0322770e1475105591
<span class="go">[preflight] Running pre-flight checks.
    [WARNING FileExisting-crictl]: crictl not found in system path
Suggestion: go get github.com/kubernetes-incubator/cri-tools/cmd/crictl
[discovery] Trying to connect to API Server "192.168.1.5:6443"
[discovery] Created cluster-info discovery client, requesting info from "https://192.168.1.5:6443"
[discovery] Requesting info from "https://192.168.1.5:6443" again to validate TLS against the pinned public key
[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server "192.168.1.5:6443"
[discovery] Successfully established connection with API Server "192.168.1.5:6443"

This node has joined the cluster:
* Certificate signing request was sent to master and a response
    was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the master to see this node join the cluster.</span></code></pre></figure>

<p>Check if the flannel interface is created and should have the pod network ip 40.168.x.x</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span>ip a show flannel.1
<span class="gp">5: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1450 qdisc noqueue state UNKNOWN group default 
<span class="go">    link/ether ee:0d:1d:5c:48:6a brd ff:ff:ff:ff:ff:ff
    inet 40.168.1.0/32 scope global flannel.1
        valid_lft forever preferred_lft forever
    inet6 fe80::ec0d:1dff:fe5c:486a/64 scope link 
        valid_lft forever preferred_lft forever
</span><span class="gp">[root@drona-child-3 ~]#</span><span class="w"> </span></code></pre></figure>

<p>Since cluster and authentication keys(~/.kube/config) not configured in secondary nodes(drona-child-3) we cannot run kubectl get nodes in secondary.</p>

<p>We have to do all the orchestration activity from the master node. I am connecting to the master node and checking the nodes status</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get nodes
<span class="go">NAME STATUS ROLES AGE VERSION
drona-child-1 Ready master 22h v1.10.4
</span><span class="gp">drona-child-3 Ready &lt;none&gt;</span><span class="w"> </span>1m v1.10.4
<span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<h3 id="creating-deployment-in-kubernetes-cluster">Creating deployment in kubernetes cluster</h3>

<p>Let try deploying a pod. I am using nginx server. The below command will automatically pull the nginx image from the docker hub and deploy it as pod.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl run nginx <span class="nt">--image</span> nginx
<span class="go">deployment.apps "nginx" created
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pods
<span class="go">NAME READY STATUS RESTARTS AGE
nginx-65899c769f-nllp5 1/1 Running 0 5m</span></code></pre></figure>

<p>Now we can see the deployment “nginx” is created.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get deployments
<span class="go">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
nginx 1 1 1 0 2s</span></code></pre></figure>

<p>To see more details about the deployment , use the describe command</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl describe deployment nginx 
<span class="go">Name: nginx
Namespace: default
CreationTimestamp: Fri, 15 Jun 2018 15:13:02 +0530
Labels: run=nginx
Annotations: deployment.kubernetes.io/revision=1
Selector: run=nginx
Replicas: 1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType: RollingUpdate
MinReadySeconds: 0
RollingUpdateStrategy: 1 max unavailable, 1 max surge
Pod Template:
    Labels: run=nginx
    Containers:
    nginx:
    Image: nginx
</span><span class="gp">    Port: &lt;none&gt;</span><span class="w">
</span><span class="gp">    Host Port: &lt;none&gt;</span><span class="w">
</span><span class="gp">    Environment: &lt;none&gt;</span><span class="w">
</span><span class="gp">    Mounts: &lt;none&gt;</span><span class="w">
</span><span class="gp">    Volumes: &lt;none&gt;</span><span class="w">
</span><span class="go">Conditions:
    Type Status Reason
    ---- ------ ------
    Available True MinimumReplicasAvailable
    Progressing True NewReplicaSetAvailable
</span><span class="gp">OldReplicaSets: &lt;none&gt;</span><span class="w">
</span><span class="go">NewReplicaSet: nginx-65899c769f (1/1 replicas created)
Events:
    Type Reason Age From Message
    ---- ------ ---- ---- -------
    Normal ScalingReplicaSet 9m deployment-controller Scaled up replica set nginx-65899c769f to 1
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<h3 id="scaling-the-pods">Scaling the pods</h3>

<p>Now let scale the pod to 3 replica</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl scale deployment nginx <span class="nt">--replicas</span><span class="o">=</span>3
<span class="go">deployment.extensions "nginx" scaled
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get deployment nginx 
<span class="go">NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
nginx 3 3 3 3 46m</span></code></pre></figure>

<p>List the pods and verify it.</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pod <span class="nt">-o</span> wide
<span class="go">NAME READY STATUS RESTARTS AGE IP NODE
nginx-768979984b-6d27s 1/1 Running 0 1m 40.168.1.5 drona-child-3
nginx-768979984b-mmgbj 1/1 Running 0 1m 40.168.1.4 drona-child-3
nginx-768979984b-vm74x 1/1 Running 0 13m 40.168.1.3 drona-child-3
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<p>Now delete one of the pod and see if it is automatically scaling up to 3</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl delete pod nginx-768979984b-vm74x 
<span class="go">pod "nginx-768979984b-vm74x" deleted
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pod <span class="nt">-o</span> wide
<span class="go">NAME READY STATUS RESTARTS AGE IP NODE
nginx-768979984b-6d27s 1/1 Running 0 6m 40.168.1.5 drona-child-3
</span><span class="gp">nginx-768979984b-9lddt 0/1 ContainerCreating 0 2s &lt;none&gt;</span><span class="w"> </span>drona-child-3
<span class="go">nginx-768979984b-mmgbj 1/1 Running 0 6m 40.168.1.4 drona-child-3
</span><span class="gp">nginx-768979984b-vm74x 0/1 Terminating 0 18m &lt;none&gt;</span><span class="w"> </span>drona-child-3
<span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span>kubectl get pod <span class="nt">-o</span> wide
<span class="go">NAME READY STATUS RESTARTS AGE IP NODE
nginx-768979984b-6d27s 1/1 Running 0 6m 40.168.1.5 drona-child-3
nginx-768979984b-9lddt 1/1 Running 0 20s 40.168.1.6 drona-child-3
nginx-768979984b-mmgbj 1/1 Running 0 6m 40.168.1.4 drona-child-3
</span><span class="gp">vikki@drona-child-1:~$</span><span class="w"> </span></code></pre></figure>
